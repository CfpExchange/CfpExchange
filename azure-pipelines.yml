pool:
  name: Azure Pipelines

variables:
 BuildConfiguration: 'release'
 BuildPlatform: 'any cpu'

stages:

- stage: Build
  jobs:

  - job: Build_Solution
    displayName: 'Build, Test and Publish'
    pool:
      vmImage: 'windows-latest'

    steps:
    - task: UseDotNet@2
      inputs:
        version: 3.x

    - task: DotNetCoreCLI@2
      displayName: 'Build CfpExchange'
      inputs:
        projects: '**/**.csproj'
        arguments: '--configuration $(BuildConfiguration) /p:platform="$(BuildPlatform)" /p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation=$(build.artifactstagingdirectory)'

    - task: DotNetCoreCLI@2
      displayName: 'Run CfpExchange unit tests'
      inputs:
        command: test
        projects: '**/*.UnitTests.csproj'
        arguments: '--configuration $(BuildConfiguration) --collect "Code coverage"'

    - task: CopyFiles@2
      displayName: 'Copy Infrastructure Code'
      inputs:
        SourceFolder: 'Deployment'
        Contents: |
          **/*.ps1
          **/*.json
        TargetFolder: '$(build.artifactstagingdirectory)/Deployment'
        flattenFolders: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact'
      inputs:
        PathtoPublish: '$(build.artifactstagingdirectory)'
